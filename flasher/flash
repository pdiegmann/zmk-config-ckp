#!/usr/bin/env zsh

# generated by running 
# makeself './flasher' flash "Custom BT75 Flasher" "./flash"
# needs makeself:
# temp_dir=$(mktemp -d) | wget -qO- https://api.github.com/repos/megastep/makeself/releases/latest | grep "/makeself-" | cut -d : -f 2,3 | tr -d \" | xargs wget -q -O "$temp_dir/makeself.sh" - | bash "$temp_dir/makeself.sh" "./flasher" flash "Custom BT75 Flasher" "./flash"

function try_flash() {
    echo "looking for board..."

    target="/Volumes/CKP/CURRENT.UF2"

    if test -f "/Volumes/CKP/CURRENT.UF2"; then
        echo "looking for firmware..."

        temp_file=$(mktemp)
        wget -q https://github.com/pdiegmann/zmk-config-ckp/releases/firmware.uf2 -O $temp_file
        if ls temp_file 1> /dev/null 2>&1; then
            echo "flashing ${temp_file} to $TARGET..."
            cp $temp_file $TARGET
            return 0
        else
            echo "no firmware found, using default..."
            cp firmware.uf2 $TARGET
            echo "done!"
            return 0
        fi
    else
        echo "no board found!"
        return 2
    fi
}

for i in $(seq 1 10); do [ $i -gt 1 ] && sleep 5; try_flash && s=0 && break || s=$?; done; (exit $s)